{% extends "base.html" %}

{% block title %}Admin Panel - Fuel Extractor{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <i class="fas fa-shield-alt text-red-500"></i>
            Admin Panel
        </h1>
        <p class="text-gray-600">System management and development tools</p>
    </div>
    <form method="POST" action="/admin/logout">
        <button type="submit" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </form>
</div>

<!-- Toast Container -->
<div id="admin-toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Action completed</span>
    </div>
</div>

<!-- System Status -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center gap-3">
            <div class="p-3 bg-blue-100 rounded-lg">
                <i class="fas fa-database text-blue-600"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Database</p>
                <p class="text-xl font-bold text-gray-800">{{ stats.db_records }} records</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center gap-3">
            <div class="p-3 bg-green-100 rounded-lg">
                <i class="fas fa-table text-green-600"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Google Sheets</p>
                <p class="text-xl font-bold text-gray-800">{{ stats.sheets_records }} records</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center gap-3">
            <div class="p-3 bg-yellow-100 rounded-lg">
                <i class="fas fa-clock text-yellow-600"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Pending</p>
                <p class="text-xl font-bold text-gray-800">{{ stats.pending_approvals }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center gap-3">
            <div class="p-3 {{ 'bg-green-100' if stats.evolution_connected else 'bg-red-100' }} rounded-lg">
                <i class="fab fa-whatsapp {{ 'text-green-600' if stats.evolution_connected else 'text-red-600' }}"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Evolution API</p>
                <p class="text-xl font-bold {{ 'text-green-600' if stats.evolution_connected else 'text-red-600' }}">
                    {{ 'Connected' if stats.evolution_connected else 'Offline' }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Data Sync Section -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-sync text-blue-500"></i>
        Data Synchronization
    </h2>
    <div class="flex gap-4">
        <button onclick="syncData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            Sync DB ↔ Sheets
        </button>
        <button onclick="exportBackup()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center gap-2">
            <i class="fas fa-download"></i>
            Export Backup (JSON)
        </button>
    </div>
    <p class="text-gray-500 text-sm mt-3">
        <i class="fas fa-info-circle mr-1"></i>
        Sync will copy missing records between Database and Google Sheets
    </p>
</div>

<!-- Fleet Management Section -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-car text-purple-500"></i>
        Fleet Management
    </h2>
    <div class="mb-4">
        <p class="text-gray-600 mb-2">Current fleet: <span class="font-semibold">{{ fleet_count }} vehicles</span></p>
    </div>
    <form onsubmit="addVehicle(event)" class="flex gap-3 mb-4">
        <input type="text" 
               id="new-plate" 
               placeholder="Enter plate number (e.g., KCA 123X)" 
               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
               pattern="[A-Za-z0-9 ]+"
               required>
        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg flex items-center gap-2">
            <i class="fas fa-plus"></i>
            Add Vehicle
        </button>
    </form>
    <div id="fleet-list" class="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto">
        <div class="flex flex-wrap gap-2">
            {% for plate in fleet %}
            <span class="bg-white border border-gray-200 px-3 py-1 rounded-lg text-sm font-mono flex items-center gap-2">
                {{ plate }}
                <button onclick="removeVehicle('{{ plate }}')" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            </span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Cache Management -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-broom text-teal-500"></i>
        Cache & Reset Tools
    </h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button onclick="clearCooldowns()" class="bg-teal-100 hover:bg-teal-200 text-teal-700 px-4 py-3 rounded-lg flex flex-col items-center gap-2">
            <i class="fas fa-clock text-xl"></i>
            <span class="text-sm font-medium">Clear Cooldowns</span>
        </button>
        <button onclick="clearPending()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-4 py-3 rounded-lg flex flex-col items-center gap-2">
            <i class="fas fa-hourglass-half text-xl"></i>
            <span class="text-sm font-medium">Clear Pending</span>
        </button>
        <button onclick="clearMessageCache()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-3 rounded-lg flex flex-col items-center gap-2">
            <i class="fas fa-envelope text-xl"></i>
            <span class="text-sm font-medium">Clear Messages</span>
        </button>
        <button onclick="cleanupOldFiles()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg flex flex-col items-center gap-2">
            <i class="fas fa-trash-alt text-xl"></i>
            <span class="text-sm font-medium">Cleanup Old (30d)</span>
        </button>
    </div>
</div>

<!-- Danger Zone -->
<div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-6">
    <h2 class="text-lg font-semibold text-red-800 mb-4 flex items-center gap-2">
        <i class="fas fa-exclamation-triangle text-red-500"></i>
        Danger Zone (Development)
    </h2>
    <p class="text-red-600 text-sm mb-4">
        <i class="fas fa-warning mr-1"></i>
        These actions are irreversible. Make sure to export a backup first!
    </p>
    <div class="flex flex-wrap gap-3">
        <button onclick="confirmAction('clear-all', '⚠️ FULL SYSTEM RESET ⚠️\n\nThis will DELETE EVERYTHING:\n• All Database records\n• All Google Sheets records\n• All JSON data files\n• All cached messages\n• All pending approvals\n• All cooldown history\n\nThe system will be completely fresh!\n\nAre you SURE?')" 
                class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg flex items-center gap-2">
            <i class="fas fa-bomb"></i>
            Clear All Data (Full Reset)
        </button>
        <button onclick="confirmAction('clear-db', 'DELETE ALL records from Database only?')" 
                class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-lg flex items-center gap-2">
            <i class="fas fa-database"></i>
            Clear DB Only
        </button>
        <button onclick="confirmAction('clear-sheets', 'DELETE ALL records from Google Sheets only?')" 
                class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-lg flex items-center gap-2">
            <i class="fas fa-table"></i>
            Clear Sheets Only
        </button>
    </div>
</div>

<!-- Configuration Display -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-cog text-gray-500"></i>
        Current Configuration
    </h2>
    <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <span class="text-gray-500">Group JID:</span>
                <span class="text-gray-800 ml-2">{{ config.group_jid }}</span>
            </div>
            <div>
                <span class="text-gray-500">Cooldown:</span>
                <span class="text-gray-800 ml-2">{{ config.cooldown_hours }} hours</span>
            </div>
            <div>
                <span class="text-gray-500">Webhook:</span>
                <span class="text-gray-800 ml-2 break-all">{{ config.webhook_url }}</span>
            </div>
            <div>
                <span class="text-gray-500">Upload to:</span>
                <span class="text-gray-800 ml-2">
                    {% if config.upload_db %}<span class="text-green-600">DB ✓</span>{% else %}<span class="text-red-500">DB ✗</span>{% endif %}
                    |
                    {% if config.upload_sheets %}<span class="text-green-600">Sheets ✓</span>{% else %}<span class="text-red-500">Sheets ✗</span>{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Audit Log Section -->
<div class="bg-white rounded-xl shadow p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
            <i class="fas fa-history text-orange-500"></i>
            Audit Log
            <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full ml-2">Protected</span>
        </h2>
        <button onclick="showAuditLogin()" class="bg-orange-100 hover:bg-orange-200 text-orange-700 px-4 py-2 rounded-lg flex items-center gap-2">
            <i class="fas fa-eye"></i>
            View Logs
        </button>
    </div>
    <div id="audit-login-form" class="hidden mb-4 bg-orange-50 border border-orange-200 rounded-lg p-4">
        <form onsubmit="viewAuditLog(event)" class="flex gap-3 items-end">
            <div class="flex-1">
                <label class="block text-gray-700 text-sm font-medium mb-1">Audit Log Password</label>
                <input type="password" 
                       id="audit-password" 
                       placeholder="Enter audit password"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
            <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg">
                View Log
            </button>
        </form>
    </div>
    <div id="audit-log-content" class="hidden">
        <div class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-700">
                        <th class="text-left py-2">Timestamp</th>
                        <th class="text-left py-2">Action</th>
                        <th class="text-left py-2">Details</th>
                        <th class="text-left py-2">Result</th>
                    </tr>
                </thead>
                <tbody id="audit-log-body" class="text-gray-300 font-mono text-xs">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4">
        <div class="text-center mb-4">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Confirm Action</h3>
            <p id="confirm-message" class="text-gray-600 mt-2">Are you sure?</p>
        </div>
        <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg">
                Cancel
            </button>
            <button id="confirm-btn" onclick="executeAction()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg">
                Confirm Delete
            </button>
        </div>
    </div>
</div>

<script>
let pendingAction = null;

function showToast(message, isError = false) {
    const toast = document.getElementById('admin-toast');
    const msgEl = document.getElementById('toast-message');
    msgEl.textContent = message;
    
    const toastDiv = toast.querySelector('div');
    if (isError) {
        toastDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2';
    } else {
        toastDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2';
    }
    
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

async function syncData() {
    try {
        showToast('Syncing...');
        const response = await fetch('/api/sync', { method: 'POST' });
        const data = await response.json();
        showToast(`Synced: ${data.db_to_sheets} to Sheets, ${data.sheets_to_db} to DB`);
        setTimeout(() => location.reload(), 1500);
    } catch (error) {
        showToast('Sync failed: ' + error.message, true);
    }
}

async function exportBackup() {
    try {
        const response = await fetch('/api/admin/export');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fuel_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showToast('Backup downloaded!');
    } catch (error) {
        showToast('Export failed: ' + error.message, true);
    }
}

async function addVehicle(event) {
    event.preventDefault();
    const plate = document.getElementById('new-plate').value.trim().toUpperCase();
    if (!plate) return;
    
    try {
        const response = await fetch('/api/admin/fleet/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plate })
        });
        const data = await response.json();
        if (data.status === 'added') {
            showToast(`Vehicle ${plate} added!`);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Failed to add vehicle', true);
        }
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

async function removeVehicle(plate) {
    if (!confirm(`Remove ${plate} from fleet?`)) return;
    
    try {
        const response = await fetch('/api/admin/fleet/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plate })
        });
        const data = await response.json();
        if (data.status === 'removed') {
            showToast(`Vehicle ${plate} removed!`);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Failed to remove vehicle', true);
        }
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

async function clearCooldowns() {
    if (!confirm('Clear all car cooldowns? This will allow all vehicles to fuel immediately.')) return;
    
    try {
        const response = await fetch('/api/admin/clear-cooldowns', { method: 'POST' });
        const data = await response.json();
        showToast('Cooldowns cleared!');
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

async function clearPending() {
    if (!confirm('Clear all pending approvals?')) return;
    
    try {
        const response = await fetch('/api/admin/clear-pending', { method: 'POST' });
        const data = await response.json();
        showToast('Pending approvals cleared!');
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

async function clearMessageCache() {
    if (!confirm('Clear processed and raw message cache files?')) return;
    
    try {
        const response = await fetch('/api/admin/clear-messages', { method: 'POST' });
        const data = await response.json();
        showToast(`Cleared ${data.files_removed || 0} files!`);
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

async function cleanupOldFiles() {
    try {
        const response = await fetch('/api/cleanup?days=30', { method: 'POST' });
        const data = await response.json();
        showToast('Cleanup complete!');
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

function confirmAction(action, message) {
    pendingAction = action;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
    pendingAction = null;
}

async function executeAction() {
    if (!pendingAction) return;
    
    closeModal();
    showToast('Processing...');
    
    try {
        const response = await fetch(`/api/admin/${pendingAction}`, { method: 'POST' });
        const data = await response.json();
        if (data.status === 'success') {
            showToast(data.message || 'Action completed!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message || 'Action failed', true);
        }
    } catch (error) {
        showToast('Error: ' + error.message, true);
    }
}

function showAuditLogin() {
    document.getElementById('audit-login-form').classList.toggle('hidden');
}

async function viewAuditLog(event) {
    event.preventDefault();
    const password = document.getElementById('audit-password').value;
    
    try {
        const response = await fetch('/api/admin/audit-log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });
        
        if (response.status === 403) {
            showToast('Invalid audit password', true);
            return;
        }
        
        const data = await response.json();
        const tbody = document.getElementById('audit-log-body');
        tbody.innerHTML = '';
        
        if (data.logs && data.logs.length > 0) {
            data.logs.reverse().forEach(log => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-800';
                row.innerHTML = `
                    <td class="py-2">${log.timestamp}</td>
                    <td class="py-2"><span class="px-2 py-1 rounded ${getActionColor(log.action)}">${log.action}</span></td>
                    <td class="py-2">${log.details || '-'}</td>
                    <td class="py-2 ${log.result === 'success' ? 'text-green-400' : 'text-red-400'}">${log.result}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No audit logs found</td></tr>';
        }
        
        document.getElementById('audit-login-form').classList.add('hidden');
        document.getElementById('audit-log-content').classList.remove('hidden');
        
    } catch (error) {
        showToast('Error loading audit log: ' + error.message, true);
    }
}

function getActionColor(action) {
    if (action.includes('clear') || action.includes('delete')) return 'bg-red-900 text-red-200';
    if (action.includes('add')) return 'bg-green-900 text-green-200';
    if (action.includes('sync')) return 'bg-blue-900 text-blue-200';
    return 'bg-gray-700 text-gray-200';
}
</script>
{% endblock %}
