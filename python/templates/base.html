<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Fuel Extractor{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar { transition: width 0.3s; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .fade-update {
            animation: fadeHighlight 1s ease-out;
        }
        @keyframes fadeHighlight {
            0% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar w-64 bg-gray-900 min-h-screen fixed left-0 top-0">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-gas-pump text-green-400"></i>
                    Fuel Extractor
                </h1>
            </div>
            <nav class="p-4">
                <ul class="space-y-2">
                    <li>
                        <a href="/" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg {% if request.url.path == '/' %}bg-gray-800 text-white{% endif %}">
                            <i class="fas fa-chart-line w-5"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="/records" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg {% if '/records' in request.url.path %}bg-gray-800 text-white{% endif %}">
                            <i class="fas fa-table w-5"></i>
                            <span>Records</span>
                        </a>
                    </li>
                    <li>
                        <a href="/analytics" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg {% if '/analytics' in request.url.path %}bg-gray-800 text-white{% endif %}">
                            <i class="fas fa-chart-pie w-5"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li>
                        <a href="/approvals" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg {% if '/approvals' in request.url.path %}bg-gray-800 text-white{% endif %}">
                            <i class="fas fa-clock w-5"></i>
                            <span>Approvals</span>
                            <span id="approval-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="/fleet" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg {% if '/fleet' in request.url.path %}bg-gray-800 text-white{% endif %}">
                            <i class="fas fa-car w-5"></i>
                            <span>Fleet</span>
                        </a>
                    </li>
                    <li class="pt-4 mt-4 border-t border-gray-700">
                        <a href="/admin" class="flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-red-900 hover:text-red-200 rounded-lg {% if '/admin' in request.url.path %}bg-red-900 text-red-200{% endif %}">
                            <i class="fas fa-shield-alt w-5"></i>
                            <span>Admin</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-700">
                <div class="text-gray-500 text-xs">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="connection-indicator" class="w-2 h-2 bg-green-400 rounded-full live-indicator"></span>
                        <span id="connection-status">Live Updates</span>
                    </div>
                    <div>WhatsApp Fuel Extractor v1.0</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-8">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Real-time Updates Script -->
    <script>
        // Global state for real-time updates
        window.FuelExtractor = {
            eventSource: null,
            charts: {},
            lastUpdate: null,
            reconnectAttempts: 0,
            maxReconnectAttempts: 10,
            
            init() {
                this.connectSSE();
                this.updateApprovalBadge();
            },
            
            connectSSE() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
                
                this.eventSource = new EventSource('/api/stream');
                
                this.eventSource.onopen = () => {
                    console.log('ðŸ“¡ SSE Connected - Real-time updates active');
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus(true);
                };
                
                this.eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'update') {
                            this.handleUpdate(data);
                        } else if (data.type === 'heartbeat') {
                            this.lastUpdate = new Date(data.timestamp);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                    }
                };
                
                this.eventSource.onerror = () => {
                    console.warn('ðŸ“¡ SSE Connection lost, reconnecting...');
                    this.updateConnectionStatus(false);
                    this.eventSource.close();
                    
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        setTimeout(() => this.connectSSE(), 3000 * this.reconnectAttempts);
                    }
                };
            },
            
            updateConnectionStatus(connected) {
                const indicator = document.getElementById('connection-indicator');
                const status = document.getElementById('connection-status');
                
                if (indicator && status) {
                    if (connected) {
                        indicator.className = 'w-2 h-2 bg-green-400 rounded-full live-indicator';
                        status.textContent = 'Live Updates';
                    } else {
                        indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full';
                        status.textContent = 'Reconnecting...';
                    }
                }
            },
            
            handleUpdate(data) {
                console.log('ðŸ“Š Data update received');
                
                // Update stats cards if on dashboard
                if (data.stats) {
                    this.updateStatsCards(data.stats);
                }
                
                // Update charts if available
                if (data.chart_data) {
                    this.updateCharts(data.chart_data);
                }
                
                // Update recent records table
                if (data.recent_records) {
                    this.updateRecentRecords(data.recent_records);
                }
                
                // Update approval badge
                this.updateApprovalBadge(data.pending_approvals);
                
                // Show toast notification
                this.showToast('ðŸ“Š Dashboard updated with new data', 'success');
            },
            
            updateStatsCards(stats) {
                const updates = {
                    'today-liters': `${(stats.today_liters || 0).toFixed(1)} L`,
                    'today-amount': `KSH ${(stats.today_amount || 0).toLocaleString()}`,
                    'week-liters': `${(stats.week_liters || 0).toFixed(1)} L`,
                    'week-amount': `KSH ${(stats.week_amount || 0).toLocaleString()}`,
                    'total-records': stats.total_records || 0,
                    'unique-vehicles': `${stats.unique_vehicles || 0} vehicles`,
                    'pending-count': stats.pending_approvals || 0,
                };
                
                for (const [id, value] of Object.entries(updates)) {
                    const el = document.getElementById(id);
                    if (el && el.textContent !== String(value)) {
                        el.textContent = value;
                        el.classList.add('fade-update');
                        setTimeout(() => el.classList.remove('fade-update'), 1000);
                    }
                }
            },
            
            updateCharts(chartData) {
                // Update daily chart if exists
                if (this.charts.daily && chartData.daily) {
                    this.charts.daily.data.labels = chartData.daily.labels.map(d => d.slice(5));
                    this.charts.daily.data.datasets[0].data = chartData.daily.liters;
                    this.charts.daily.update('none');
                }
                
                // Update department chart if exists
                if (this.charts.department && chartData.by_department) {
                    this.charts.department.data.labels = chartData.by_department.labels;
                    this.charts.department.data.datasets[0].data = chartData.by_department.values;
                    this.charts.department.update('none');
                }
            },
            
            updateRecentRecords(records) {
                const tbody = document.getElementById('recent-records-tbody');
                if (!tbody || !records.length) return;
                
                const html = records.map(record => `
                    <tr class="hover:bg-gray-50 fade-update">
                        <td class="px-6 py-4 text-sm text-gray-600">${(record.datetime || '').slice(0, 16)}</td>
                        <td class="px-6 py-4">
                            <span class="font-medium text-gray-800">${record.car || ''}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${record.driver || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${record.department || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-800 text-right">${(record.liters || 0).toFixed(1)} L</td>
                        <td class="px-6 py-4 text-sm text-gray-800 text-right">KSH ${(record.amount || 0).toLocaleString()}</td>
                    </tr>
                `).join('');
                
                tbody.innerHTML = html;
            },
            
            updateApprovalBadge(count) {
                const badge = document.getElementById('approval-badge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            },
            
            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg flex items-center gap-2`;
                toast.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-80">Ã—</button>
                `;
                
                container.appendChild(toast);
                
                // Auto-remove after 4 seconds
                setTimeout(() => toast.remove(), 4000);
            },
            
            registerChart(name, chart) {
                this.charts[name] = chart;
            }
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            window.FuelExtractor.init();
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
