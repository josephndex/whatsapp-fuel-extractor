{% extends "base.html" %}

{% block title %}Analytics - Fuel Extractor{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Analytics</h1>
            <p class="text-gray-600">Detailed fuel consumption analysis</p>
        </div>
    </div>
</div>

<!-- Filters Card -->
<div class="bg-white rounded-xl shadow p-6 mb-8">
    <form id="analyticsForm" method="get" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
            <!-- Data Source -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data Source</label>
                <select name="source" id="sourceSelect" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="{{ DATA_SOURCE_EXCEL }}" {% if source == DATA_SOURCE_EXCEL %}selected{% endif %}
                        {% if not available_sources.get(DATA_SOURCE_EXCEL) %}disabled{% endif %}>
                        Excel File {% if not available_sources.get(DATA_SOURCE_EXCEL) %}(Not Available){% endif %}
                    </option>
                    <option value="{{ DATA_SOURCE_DB }}" {% if source == DATA_SOURCE_DB %}selected{% endif %}
                        {% if not available_sources.get(DATA_SOURCE_DB) %}disabled{% endif %}>
                        Database {% if not available_sources.get(DATA_SOURCE_DB) %}(Not Configured){% endif %}
                    </option>
                    <option value="{{ DATA_SOURCE_SHEETS }}" {% if source == DATA_SOURCE_SHEETS %}selected{% endif %}
                        {% if not available_sources.get(DATA_SOURCE_SHEETS) %}disabled{% endif %}>
                        Google Sheets {% if not available_sources.get(DATA_SOURCE_SHEETS) %}(Not Configured){% endif %}
                    </option>
                </select>
            </div>
            
            <!-- Start Date -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" name="start_date" id="startDate" value="{{ start_date }}"
                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            
            <!-- End Date -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" name="end_date" id="endDate" value="{{ end_date }}"
                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            
            <!-- Quick Period -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quick Select</label>
                <div class="flex gap-1">
                    <button type="button" onclick="setPeriod(7)" 
                        class="px-3 py-2 text-sm rounded-lg {% if days == 7 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        7D
                    </button>
                    <button type="button" onclick="setPeriod(14)" 
                        class="px-3 py-2 text-sm rounded-lg {% if days == 14 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        14D
                    </button>
                    <button type="button" onclick="setPeriod(30)" 
                        class="px-3 py-2 text-sm rounded-lg {% if days == 30 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        30D
                    </button>
                    <button type="button" onclick="setPeriod(90)" 
                        class="px-3 py-2 text-sm rounded-lg {% if days == 90 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        90D
                    </button>
                    <button type="button" onclick="setPeriod(365)" 
                        class="px-3 py-2 text-sm rounded-lg {% if days == 365 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        1Y
                    </button>
                </div>
            </div>
            
            <!-- Apply Button -->
            <div>
                <button type="submit" 
                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                    <i class="fas fa-filter"></i>
                    Apply Filters
                </button>
            </div>
        </div>
        
        <input type="hidden" name="days" id="daysInput" value="{{ days }}">
    </form>
</div>

<!-- Summary Stats Cards -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500 text-sm">Total Records</p>
        <p class="text-2xl font-bold text-gray-800">{{ summary_stats.total_records }}</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500 text-sm">Total Fuel</p>
        <p class="text-2xl font-bold text-blue-600">{{ "{:,.1f}".format(summary_stats.total_liters) }} L</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500 text-sm">Total Spent</p>
        <p class="text-2xl font-bold text-green-600">KSH {{ "{:,.0f}".format(summary_stats.total_amount) }}</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500 text-sm">Vehicles</p>
        <p class="text-2xl font-bold text-purple-600">{{ summary_stats.unique_vehicles }}</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500 text-sm">Drivers</p>
        <p class="text-2xl font-bold text-orange-600">{{ summary_stats.unique_drivers }}</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500 text-sm">Avg Cost/Liter</p>
        <p class="text-2xl font-bold text-gray-800">KSH {{ "{:,.2f}".format(summary_stats.avg_cost_per_liter) }}</p>
    </div>
</div>

<!-- Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Daily Trend -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Fuel Consumption</h3>
        <canvas id="dailyChart" height="200"></canvas>
    </div>

    <!-- Daily Amount -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Spending (KSH)</h3>
        <canvas id="amountChart" height="200"></canvas>
    </div>

    <!-- By Department -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Spending by Department</h3>
        <canvas id="departmentChart" height="200"></canvas>
    </div>

    <!-- By Fuel Type -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Consumption by Fuel Type</h3>
        <canvas id="fuelTypeChart" height="200"></canvas>
    </div>
</div>

<!-- Top Vehicles -->
<div class="bg-white rounded-xl shadow p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 10 Vehicles by Spending</h3>
    <canvas id="vehiclesChart" height="100"></canvas>
</div>

<!-- Data Source Info -->
<div class="bg-gray-50 rounded-xl p-4 text-center text-sm text-gray-500">
    <i class="fas fa-database mr-2"></i>
    Data Source: <strong>{% if source == DATA_SOURCE_DB %}Database{% elif source == DATA_SOURCE_SHEETS %}Google Sheets{% else %}Excel File{% endif %}</strong>
    {% if start_date and end_date %}
    | Period: <strong>{{ start_date }} to {{ end_date }}</strong>
    {% elif days %}
    | Period: <strong>Last {{ days }} days</strong>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const chartData = {{ chart_data | safe }};
    
    const colors = [
        '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
        '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
    ];
    
    // Helper function to format dates nicely
    function formatDate(dateStr) {
        if (!dateStr || dateStr.length < 10) return dateStr;
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // Daily consumption chart
    new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
            labels: chartData.daily.labels.map(formatDate),
            datasets: [{
                label: 'Liters',
                data: chartData.daily.liters,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Liters' } }
            }
        }
    });
    
    // Daily amount chart
    new Chart(document.getElementById('amountChart'), {
        type: 'bar',
        data: {
            labels: chartData.daily.labels.map(formatDate),
            datasets: [{
                label: 'Amount',
                data: chartData.daily.amount,
                backgroundColor: '#10B981',
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'KSH' },
                    ticks: {
                        callback: function(value) {
                            return 'KSH ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // By department doughnut
    new Chart(document.getElementById('departmentChart'), {
        type: 'doughnut',
        data: {
            labels: chartData.by_department.labels,
            datasets: [{
                data: chartData.by_department.values,
                backgroundColor: colors,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    
    // By fuel type pie
    new Chart(document.getElementById('fuelTypeChart'), {
        type: 'pie',
        data: {
            labels: chartData.by_fuel_type.labels,
            datasets: [{
                data: chartData.by_fuel_type.values,
                backgroundColor: ['#F59E0B', '#10B981', '#3B82F6', '#EF4444'],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    
    // Top vehicles horizontal bar
    const topVehicles = chartData.top_vehicles;
    new Chart(document.getElementById('vehiclesChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(topVehicles),
            datasets: [{
                label: 'Amount (KSH)',
                data: Object.values(topVehicles),
                backgroundColor: colors,
                borderRadius: 4,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KSH ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // Quick period selection function
    function setPeriod(days) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);
        
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        document.getElementById('daysInput').value = days;
        
        // Auto-submit form
        document.getElementById('analyticsForm').submit();
    }
    
    // Initialize date inputs if empty
    document.addEventListener('DOMContentLoaded', function() {
        const startInput = document.getElementById('startDate');
        const endInput = document.getElementById('endDate');
        
        if (!endInput.value) {
            endInput.value = new Date().toISOString().split('T')[0];
        }
        
        if (!startInput.value) {
            const start = new Date();
            start.setDate(start.getDate() - {{ days }});
            startInput.value = start.toISOString().split('T')[0];
        }
    });
</script>
{% endblock %}
