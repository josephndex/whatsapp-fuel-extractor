{% extends "base.html" %}

{% block title %}Analytics - Fuel Extractor{% endblock %}

{% block content %}
<div class="mb-8 flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold text-gray-800">Analytics</h1>
        <p class="text-gray-600">Detailed fuel consumption analysis</p>
    </div>
    
    <!-- Period Selector -->
    <div class="flex gap-2">
        <a href="?days=7" class="px-4 py-2 rounded-lg {% if days == 7 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
            7 Days
        </a>
        <a href="?days=14" class="px-4 py-2 rounded-lg {% if days == 14 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
            14 Days
        </a>
        <a href="?days=30" class="px-4 py-2 rounded-lg {% if days == 30 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
            30 Days
        </a>
        <a href="?days=90" class="px-4 py-2 rounded-lg {% if days == 90 %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
            90 Days
        </a>
    </div>
</div>

<!-- Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Daily Trend -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Fuel Consumption</h3>
        <canvas id="dailyChart" height="200"></canvas>
    </div>

    <!-- Daily Amount -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Spending (KSH)</h3>
        <canvas id="amountChart" height="200"></canvas>
    </div>

    <!-- By Department -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Spending by Department</h3>
        <canvas id="departmentChart" height="200"></canvas>
    </div>

    <!-- By Fuel Type -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Consumption by Fuel Type</h3>
        <canvas id="fuelTypeChart" height="200"></canvas>
    </div>
</div>

<!-- Top Vehicles -->
<div class="bg-white rounded-xl shadow p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 10 Vehicles by Spending</h3>
    <canvas id="vehiclesChart" height="100"></canvas>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chartData = {{ chart_data | safe }};
    
    const colors = [
        '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
        '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
    ];
    
    // Daily consumption
    new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
            labels: chartData.daily.labels.map(d => d.slice(5)),
            datasets: [{
                label: 'Liters',
                data: chartData.daily.liters,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Liters' } }
            }
        }
    });
    
    // Daily amount
    new Chart(document.getElementById('amountChart'), {
        type: 'bar',
        data: {
            labels: chartData.daily.labels.map(d => d.slice(5)),
            datasets: [{
                label: 'Amount',
                data: chartData.daily.amount,
                backgroundColor: '#10B981',
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'KSH' },
                    ticks: {
                        callback: function(value) {
                            return 'KSH ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // By department
    new Chart(document.getElementById('departmentChart'), {
        type: 'doughnut',
        data: {
            labels: chartData.by_department.labels,
            datasets: [{
                data: chartData.by_department.values,
                backgroundColor: colors,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    
    // By fuel type
    new Chart(document.getElementById('fuelTypeChart'), {
        type: 'pie',
        data: {
            labels: chartData.by_fuel_type.labels,
            datasets: [{
                data: chartData.by_fuel_type.values,
                backgroundColor: ['#F59E0B', '#10B981', '#3B82F6', '#EF4444'],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    
    // Top vehicles
    const topVehicles = chartData.top_vehicles;
    new Chart(document.getElementById('vehiclesChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(topVehicles),
            datasets: [{
                label: 'Amount (KSH)',
                data: Object.values(topVehicles),
                backgroundColor: colors,
                borderRadius: 4,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KSH ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
